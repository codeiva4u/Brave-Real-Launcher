name: Chrome Launcher Sync & Publish

on:
  # Automatic trigger - daily check for updates
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM UTC
  
  # Manual trigger
  workflow_dispatch:
    inputs:
      chrome_launcher_version:
        description: 'Chrome-launcher version to sync (leave empty for latest)'
        required: false
        default: 'latest'
      force_publish:
        description: 'Force publish even if no updates'
        type: boolean
        default: false
      skip_tests:
        description: 'Skip tests (use carefully)'
        type: boolean
        default: false

  # Trigger on push to main (for testing)
  push:
    branches: [ main, master ]
    paths:
      - 'scripts/chrome-launcher-sync.cjs'
      - '.github/workflows/chrome-launcher-sync.yml'

env:
  NODE_VERSION: '18'
  REGISTRY_URL: 'https://registry.npmjs.org'

jobs:
  check-updates:
    name: Check for Chrome-launcher Updates
    runs-on: ubuntu-latest
    outputs:
      has_updates: ${{ steps.check.outputs.has_updates }}
      chrome_version: ${{ steps.check.outputs.chrome_version }}
      current_version: ${{ steps.check.outputs.current_version }}
      should_proceed: ${{ steps.check.outputs.should_proceed }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Check Chrome-launcher Updates
        id: check
        run: |
          echo "ðŸ” Checking for chrome-launcher updates..."
          
          # Get current version from package.json
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current brave-real-launcher version: $CURRENT_VERSION"
          
          # Get latest chrome-launcher version
          if [ "${{ github.event.inputs.chrome_launcher_version }}" = "latest" ] || [ -z "${{ github.event.inputs.chrome_launcher_version }}" ]; then
            # Get latest chrome-launcher version from npm
            CHROME_VERSION=$(npm view chrome-launcher version)
            echo "chrome_version=$CHROME_VERSION" >> $GITHUB_OUTPUT
            echo "Latest chrome-launcher version: $CHROME_VERSION"
          else
            CHROME_VERSION="${{ github.event.inputs.chrome_launcher_version }}"
            echo "chrome_version=$CHROME_VERSION" >> $GITHUB_OUTPUT
            echo "Target chrome-launcher version: $CHROME_VERSION"
          fi
          
          # Check if we should proceed
          FORCE_PUBLISH="${{ github.event.inputs.force_publish }}"
          
          if [ "$CURRENT_VERSION" != "$CHROME_VERSION" ] || [ "$FORCE_PUBLISH" = "true" ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "should_proceed=true" >> $GITHUB_OUTPUT
            echo "âœ… Updates available or force publish requested"
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "should_proceed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No updates available"
          fi

  sync-and-build:
    name: Sync Chrome-launcher & Build
    runs-on: ubuntu-latest
    needs: check-updates
    if: needs.check-updates.outputs.should_proceed == 'true'
    
    outputs:
      build_success: ${{ steps.build.outputs.success }}
      new_version: ${{ steps.sync.outputs.new_version }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          registry-url: ${{ env.REGISTRY_URL }}

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install Dependencies
        run: npm ci

      - name: Sync Chrome-launcher
        id: sync
        run: |
          echo "ðŸ”„ Starting chrome-launcher sync..."
          
          # Run the sync script
          TARGET_VERSION="${{ needs.check-updates.outputs.chrome_version }}"
          node scripts/chrome-launcher-sync.cjs "$TARGET_VERSION"
          
          # Get the new version from package.json
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "âœ… Synced to version: $NEW_VERSION"

      - name: Install Updated Dependencies
        run: |
          echo "ðŸ“¦ Installing updated dependencies..."
          npm install

      - name: Build Project
        id: build
        run: |
          echo "ðŸ”¨ Building project..."
          npm run build
          echo "success=true" >> $GITHUB_OUTPUT
          echo "âœ… Build completed successfully"

      - name: Run Tests
        if: github.event.inputs.skip_tests != 'true'
        run: |
          echo "ðŸ§ª Running tests..."
          npm run test:ci
          echo "âœ… All tests passed"

      - name: Verify Build Output
        run: |
          echo "ðŸ” Verifying build outputs..."
          ls -la dist/
          node -e "console.log('âœ… Build verification:', require('./dist/index.js') ? 'Success' : 'Failed')"

      - name: Commit Changes
        run: |
          if git diff --quiet; then
            echo "No changes to commit"
          else
            git add .
            git commit -m "chore: sync with chrome-launcher v${{ steps.sync.outputs.new_version }}
            
            - Updated to chrome-launcher v${{ steps.sync.outputs.new_version }}
            - Preserved all Brave-specific features
            - Updated dependencies and configurations
            - Verified build and tests
            
            Auto-generated by GitHub Actions"
            
            git push origin ${{ github.ref_name }}
            echo "âœ… Changes committed and pushed"
          fi

  publish-npm:
    name: Publish to NPM
    runs-on: ubuntu-latest
    needs: [check-updates, sync-and-build]
    if: needs.sync-and-build.outputs.build_success == 'true'
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}
          token: ${{ secrets.GH_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          registry-url: ${{ env.REGISTRY_URL }}

      - name: Install Dependencies
        run: npm ci

      - name: Build for Publication
        run: |
          echo "ðŸ”¨ Building for publication..."
          npm run build
          echo "âœ… Build completed"

      - name: Final Tests Before Publish
        if: github.event.inputs.skip_tests != 'true'
        run: |
          echo "ðŸ§ª Running final tests..."
          npm run test:ci
          echo "âœ… All tests passed"

      - name: Check NPM Authentication
        run: |
          echo "ðŸ” Checking NPM authentication..."
          npm whoami
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish to NPM
        run: |
          echo "ðŸ“¦ Publishing to NPM..."
          
          # Get package info
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          
          echo "Publishing $PACKAGE_NAME@$PACKAGE_VERSION"
          
          # Publish with retry logic
          npm publish --access public
          
          echo "âœ… Successfully published $PACKAGE_NAME@$PACKAGE_VERSION"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        with:
          tag_name: v${{ needs.sync-and-build.outputs.new_version }}
          release_name: Release v${{ needs.sync-and-build.outputs.new_version }}
          body: |
            ## ðŸš€ Chrome-launcher Sync Update
            
            This release automatically syncs with **chrome-launcher v${{ needs.check-updates.outputs.chrome_version }}**
            
            ### âœ¨ What's Updated
            - ðŸ”„ Synced with chrome-launcher v${{ needs.check-updates.outputs.chrome_version }}
            - ðŸ¦ All Brave-specific features preserved and enhanced
            - ðŸ“¦ Dependencies updated to latest versions
            - ðŸ§ª All tests passing
            - ðŸ”¨ Build system updated
            
            ### ðŸ“‹ Sync Details
            - **Previous version:** ${{ needs.check-updates.outputs.current_version }}
            - **New version:** ${{ needs.sync-and-build.outputs.new_version }}
            - **Chrome-launcher version:** ${{ needs.check-updates.outputs.chrome_version }}
            - **Auto-published:** âœ… Available on NPM
            
            ### ðŸ”— Links
            - [NPM Package](https://www.npmjs.com/package/brave-real-launcher)
            - [Chrome-launcher Repository](https://github.com/GoogleChrome/chrome-launcher)
            
            ---
            *This release was automatically generated by GitHub Actions*
          draft: false
          prerelease: false

  notify-completion:
    name: Notify Completion
    runs-on: ubuntu-latest
    needs: [check-updates, sync-and-build, publish-npm]
    if: always()
    
    steps:
      - name: Workflow Summary
        run: |
          echo "## ðŸŽ¯ Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.check-updates.outputs.should_proceed }}" = "true" ]; then
            echo "### âœ… Updates Processed" >> $GITHUB_STEP_SUMMARY
            echo "- **Chrome-launcher version:** ${{ needs.check-updates.outputs.chrome_version }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Previous version:** ${{ needs.check-updates.outputs.current_version }}" >> $GITHUB_STEP_SUMMARY
            echo "- **New version:** ${{ needs.sync-and-build.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ needs.sync-and-build.result }}" = "success" ]; then
              echo "- **Sync & Build:** âœ… Success" >> $GITHUB_STEP_SUMMARY
            else
              echo "- **Sync & Build:** âŒ Failed" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ "${{ needs.publish-npm.result }}" = "success" ]; then
              echo "- **NPM Publish:** âœ… Success" >> $GITHUB_STEP_SUMMARY
              echo "- **Package URL:** https://www.npmjs.com/package/brave-real-launcher" >> $GITHUB_STEP_SUMMARY
            else
              echo "- **NPM Publish:** âŒ Failed" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### â„¹ï¸ No Updates Required" >> $GITHUB_STEP_SUMMARY
            echo "- Current version is already up-to-date with chrome-launcher" >> $GITHUB_STEP_SUMMARY
            echo "- **Current version:** ${{ needs.check-updates.outputs.current_version }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Chrome-launcher version:** ${{ needs.check-updates.outputs.chrome_version }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Useful Links" >> $GITHUB_STEP_SUMMARY
          echo "- [Repository](https://github.com/${{ github.repository }})" >> $GITHUB_STEP_SUMMARY
          echo "- [NPM Package](https://www.npmjs.com/package/brave-real-launcher)" >> $GITHUB_STEP_SUMMARY
          echo "- [Chrome-launcher](https://github.com/GoogleChrome/chrome-launcher)" >> $GITHUB_STEP_SUMMARY